<!doctype html>
<html class="no-js" lang="en">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />
<meta content="Minimalist Data Wrangling with Python" name="citation_title" />
<meta content="Marek Gagolewski" name="citation_author" />
<meta content="2023" name="citation_date" />
<meta content="2023" name="citation_publication_date" />
<meta content="https://datawranglingpy.gagolewski.com/datawranglingpy.pdf" name="citation_pdf_url" />
<meta content="https://datawranglingpy.gagolewski.com/" name="citation_public_url" />
<meta content="10.5281/zenodo.6451068" name="citation_doi" />
<meta content="Minimalist Data Wrangling with Python is envisaged as a student's first introduction to data science, providing a high-level overview as well as discussing key concepts in detail. We explore methods for cleaning data gathered from different sources, transforming, selecting, and extracting features, performing exploratory data analysis and dimensionality reduction, identifying naturally occurring data clusters, modelling patterns in data, comparing data between groups, and reporting the results. This textbook is a non-profit project. Its online and PDF versions are freely available at https://datawranglingpy.gagolewski.com/." name="citation_abstract" />
<meta content="summary" name="twitter:card" />
<meta content="Minimalist Data Wrangling with Python" name="twitter:title" />
<meta content="Minimalist Data Wrangling with Python" name="og:title" />
<meta content="Minimalist Data Wrangling with Python is envisaged as a student's first introduction to data science, providing a high-level overview as well as discussing key concepts in detail. We explore methods for cleaning data gathered from different sources, transforming, selecting, and extracting features, performing exploratory data analysis and dimensionality reduction, identifying naturally occurring data clusters, modelling patterns in data, comparing data between groups, and reporting the results. This textbook is a non-profit project. Its online and PDF versions are freely available at https://datawranglingpy.gagolewski.com/." name="twitter:description" />
<meta content="Minimalist Data Wrangling with Python is envisaged as a student's first introduction to data science, providing a high-level overview as well as discussing key concepts in detail. We explore methods for cleaning data gathered from different sources, transforming, selecting, and extracting features, performing exploratory data analysis and dimensionality reduction, identifying naturally occurring data clusters, modelling patterns in data, comparing data between groups, and reporting the results. This textbook is a non-profit project. Its online and PDF versions are freely available at https://datawranglingpy.gagolewski.com/." name="og:description" />
<meta content="gagolews/datawranglingpy" name="og:site_name" />
<meta content="https://datawranglingpy.gagolewski.com/" name="og:url" />
<meta content="https://datawranglingpy.gagolewski.com/_images/cover.png" name="twitter:image" />
<meta content="https://datawranglingpy.gagolewski.com/_images/cover.png" name="og:image" />
<meta content="https://datawranglingpy.gagolewski.com/" name="DC.identifier" />
<meta content="Marek Gagolewski" name="DC.publisher" />
<meta content="INDEX,FOLLOW" name="robots" />
<meta content="book" name="og:type" />
<meta content="9780645571912" name="og:book:isbn" />
<link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="Changelog" href="998-changelog.html" /><link rel="prev" title="15. Missing, censored, and questionable data" href="520-missingness.html" />
        <link rel="canonical" href="https://datawranglingpy.gagolewski.com/chapter/530-time-series.html" />

    <link rel="shortcut icon" href="../_static/favicon.png"/><!-- Generated with Sphinx 6.2.1 and Furo 2023.03.27 -->
        <title>16. Time series - Minimalist Data Wrangling with Python</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?digest=fad236701ea90a88636c2a8c73b44ae642ed2a53" />
    <link rel="stylesheet" type="text/css" href="../_static/proof.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    <link rel="stylesheet" type="text/css" href="../_static/css/custom.css" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  --admonition-font-size: 95%;
  --admonition-title-font-size: 95%;
  --color-brand-primary: red;
  --color-brand-content: #CC3333;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --admonition-font-size: 95%;
  --admonition-title-font-size: 95%;
  --color-brand-primary: #ff2b53;
  --color-brand-content: #dd3333;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --admonition-font-size: 95%;
  --admonition-title-font-size: 95%;
  --color-brand-primary: #ff2b53;
  --color-brand-content: #dd3333;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">Minimalist Data Wrangling with Python</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto colour theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky">

<span class="sidebar-brand-text">
<a class="sidebar-brand" href="../index.html">Minimalist Data Wrangling with Python</a>
</span>
<div class="sidebar-brand">
An open-access textbook<br />
by <a href='https://www.gagolewski.com' style="display: contents">Marek Gagolewski</a><br />
v1.0.3.9002
</div>
<form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">About</a></li>
<li class="toctree-l1"><a class="reference external" href="https://www.gagolewski.com/">Author</a></li>
<li class="toctree-l1"><a class="reference external" href="https://datawranglingpy.gagolewski.com/datawranglingpy.pdf">This book in PDF</a></li>
<li class="toctree-l1"><a class="reference external" href="https://www.amazon.com/dp/0645571911">Printed version</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/gagolews/datawranglingpy/">Report bugs or typos (GitHub)</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/gagolews/teaching-data">Datasets</a></li>
<li class="toctree-l1"><a class="reference external" href="https://deepr.gagolewski.com">Deep R programming</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Start here</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="000-preface.html">Preface</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Introducing Python</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="110-setup.html">1. Getting started with Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="120-scalar.html">2. Scalar types and control structures in Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="130-sequential.html">3. Sequential and other types in Python</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Unidimensional data</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="210-vector.html">4. Unidimensional numeric data and their empirical distribution</a></li>
<li class="toctree-l1"><a class="reference internal" href="220-transform-vector.html">5. Processing unidimensional data</a></li>
<li class="toctree-l1"><a class="reference internal" href="230-distribution.html">6. Continuous probability distributions</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Multidimensional data</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="310-matrix.html">7. Multidimensional numeric data at a glance</a></li>
<li class="toctree-l1"><a class="reference internal" href="320-transform-matrix.html">8. Processing multidimensional data</a></li>
<li class="toctree-l1"><a class="reference internal" href="330-relationship.html">9. Exploring relationships between variables</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Heterogeneous data</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="410-data-frame.html">10. Introducing data frames</a></li>
<li class="toctree-l1"><a class="reference internal" href="420-categorical.html">11. Handling categorical data</a></li>
<li class="toctree-l1"><a class="reference internal" href="430-group-by.html">12. Processing data in groups</a></li>
<li class="toctree-l1"><a class="reference internal" href="440-sql.html">13. Accessing databases</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Other data types</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="510-text.html">14. Text data</a></li>
<li class="toctree-l1"><a class="reference internal" href="520-missingness.html">15. Missing, censored, and questionable data</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">16. Time series</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Appendix</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="998-changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="999-bibliography.html">References</a></li>
</ul>

</div></div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="edit-this-page">
  <a class="muted-link" href="https://github.com/gagolews/datawranglingpy/issues/" title="Edit this page">
    <svg aria-hidden="true" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <path d="M4 20h4l10.5 -10.5a1.5 1.5 0 0 0 -4 -4l-10.5 10.5v4" />
      <line x1="13.5" y1="6.5" x2="17.5" y2="10.5" />
    </svg>
    <span class="visually-hidden">Edit this page</span>
  </a>
</div><div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto colour theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section class="tex2jax_ignore mathjax_ignore" id="time-series">
<span id="chap-time-series"></span><h1><span class="section-number">16. </span>Time series<a class="headerlink" href="#time-series" title="Permalink to this heading">#</a></h1>
<blockquote>
<div><p><em>The open-access textbook</em> Minimalist Data
Wrangling with Python <em>by <a class="reference external" href="https://www.gagolewski.com">Marek Gagolewski</a>
is, and will remain, freely available for everyone’s enjoyment
(also in <a class="reference external" href="https://datawranglingpy.gagolewski.com/datawranglingpy.pdf">PDF</a>;
a printed version can be ordered from
<a class="reference external" href="https://www.amazon.com/dp/0645571911">Amazon</a>:
<a class="reference external" href="https://amazon.com.au/dp/0645571911">AU</a>
<a class="reference external" href="https://amazon.ca/dp/0645571911">CA</a>
<a class="reference external" href="https://amazon.de/dp/0645571911">DE</a>
<a class="reference external" href="https://amazon.es/dp/0645571911">ES</a>
<a class="reference external" href="https://amazon.fr/dp/0645571911">FR</a>
<a class="reference external" href="https://amazon.it/dp/0645571911">IT</a>
<a class="reference external" href="https://amazon.co.jp/dp/0645571911">JP</a>
<a class="reference external" href="https://amazon.nl/dp/0645571911">NL</a>
<a class="reference external" href="https://amazon.pl/dp/0645571911">PL</a>
<a class="reference external" href="https://amazon.se/dp/0645571911">SE</a>
<a class="reference external" href="https://amazon.co.uk/dp/0645571911">UK</a>
<a class="reference external" href="https://amazon.com/dp/0645571911">US</a>).
It is a non-profit project.
Although available online, it is a whole course;
it should be read from the beginning to the end.
Refer to the <a class="reference internal" href="000-preface.html#chap-preface"><span class="std std-ref">Preface</span></a> for general introductory remarks. Any
<a class="reference external" href="https://github.com/gagolews/datawranglingpy/issues">bug/typo reports/fixes</a>
are appreciated.</em>
<em>Also, make sure to check out my other book,
<a class="reference external" href="https://deepr.gagolewski.com/"><em>Deep R Programming</em></a>
<span id="id1">[<a class="reference internal" href="999-bibliography.html#id2" title="Gagolewski, M. (2023).  Deep R Programming. Zenodo, Melbourne. early draft. URL: https://deepr.gagolewski.com/, DOI: 10.5281/zenodo.7490464.">34</a>]</span>.</em></p>
</div></blockquote>
<p>So far, we have been using <strong class="program">numpy</strong> and <strong class="program">pandas</strong>
mostly for storing:</p>
<ul class="simple">
<li><p><em>independent</em> measurements, where each row gives, e.g.,
weight, height, … records of a different subject;
we often consider these a sample of a representative
subset of one or more populations, each
recorded at a particular point in time;</p></li>
<li><p>data summaries to be reported in the form of tables or figures,
e.g., frequency distributions giving counts for the corresponding
categories or labels.</p></li>
</ul>
<p>In this chapter, we will explore the most basic concepts related to the
wrangling of <em>time series</em>, i.e., signals indexed by discrete time.
Usually, a time series is a sequence of measurements
sampled at equally spaced moments, e.g.,
a patient’s heart rate probed every second,
daily average currency exchange rates,
or highest yearly temperatures recorded in some location.</p>
<section id="temporal-ordering-and-line-charts">
<h2><span class="section-number">16.1. </span>Temporal ordering and line charts<a class="headerlink" href="#temporal-ordering-and-line-charts" title="Permalink to this heading">#</a></h2>
<p>Consider the midrange<a class="footnote-reference brackets" href="#footmidrange" id="id2" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a> daily temperatures in degrees Celsius
at the Spokane International Airport (Spokane, WA, US)
between 1889-08-01 (first observation) and 2021-12-31 (last observation).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">temps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="s2">&quot;https://raw.githubusercontent.com/gagolews/&quot;</span> <span class="o">+</span>
    <span class="s2">&quot;teaching-data/master/marek/spokane_temperature.txt&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Let us preview the December 2021 data:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">temps</span><span class="p">[</span><span class="o">-</span><span class="mi">31</span><span class="p">:]</span>  <span class="c1"># last 31 days</span>
<span class="c1">## array([ 11.9,   5.8,   0.6,   0.8,  -1.9,  -4.4,  -1.9,   1.4,  -1.9,</span>
<span class="c1">##         -1.4,   3.9,   1.9,   1.9,  -0.8,  -2.5,  -3.6, -10. ,  -1.1,</span>
<span class="c1">##         -1.7,  -5.3,  -5.3,  -0.3,   1.9,  -0.6,  -1.4,  -5. ,  -9.4,</span>
<span class="c1">##        -12.8, -12.2, -11.4, -11.4])</span>
</pre></div>
</div>
<p>Here are some data aggregates for the whole sample.
First, the popular quantiles:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">temps</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="c1">## array([-26.9,   2.2,   8.6,  16.4,  33.9])</span>
</pre></div>
</div>
<p>Then, the arithmetic mean and standard deviation:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">temps</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">temps</span><span class="p">)</span>
<span class="c1">## (8.990273958441023, 9.16204388619955)</span>
</pre></div>
</div>
<p>A graphical summary of the data distribution is depicted
in <a class="reference internal" href="#fig-spokane-violinplot"><span class="std std-numref">Figure 16.1</span></a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">violinplot</span><span class="p">(</span><span class="n">temps</span><span class="p">,</span> <span class="n">vert</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">showextrema</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">temps</span><span class="p">,</span> <span class="n">vert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<figure class="align-default" id="id7">
<span id="fig-spokane-violinplot"></span><img alt="../_images/spokane-violinplot-1.png" src="../_images/spokane-violinplot-1.png" />
<figcaption>
<p><span class="caption-number">Figure 16.1 </span><span class="caption-text">Distribution of the midrange daily temperatures in Spokane in the period 1889-2021; observations are treated as a bag of unrelated items (temperature on a “randomly chosen day” in a version of planet Earth where there is no climate change)</span><a class="headerlink" href="#id7" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<div style="margin-top: 1em"></div><p>When computing data aggregates or plotting histograms, the order of elements
does not matter. Contrary to the case of the <em>independent</em> measurements,
vectors representing time series do not have to be treated simply
as mixed bags of unrelated items.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>In time series, for any given
item <span class="math notranslate nohighlight">\(x_i\)</span>, its neighbouring elements <span class="math notranslate nohighlight">\(x_{i-1}\)</span> and <span class="math notranslate nohighlight">\(x_{i+1}\)</span>
denote the recordings occurring directly before and after it.
We can use this <em>temporal ordering</em> to model how <em>consecutive</em>
measurements <em>depend</em> on each other, describe how they
change over time, forecast future values, detect seasonal
and long-time trends, and so forth.</p>
</div>
<p><a class="reference internal" href="#fig-spokane-1-linechart"><span class="std std-numref">Figure 16.2</span></a> depicts the data for 2021,
plotted as a function of time. What we see is often referred to as a
<em>line chart</em> (line graph): data points are connected by straight line
segments.
There are some visible seasonal variations, such as, well, obviously,
that winter is colder than summer.
There is also some natural variability on top of seasonal
patterns typical for the Northern Hemisphere.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">temps</span><span class="p">[</span><span class="o">-</span><span class="mi">365</span><span class="p">:])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">181</span><span class="p">,</span> <span class="mi">364</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;2021-01-01&quot;</span><span class="p">,</span> <span class="s2">&quot;2021-07-01&quot;</span><span class="p">,</span> <span class="s2">&quot;2021-12-31&quot;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<figure class="align-default" id="id8">
<span id="fig-spokane-1-linechart"></span><img alt="../_images/spokane-1-linechart-3.png" src="../_images/spokane-1-linechart-3.png" />
<figcaption>
<p><span class="caption-number">Figure 16.2 </span><span class="caption-text">Line chart of midrange daily temperatures in Spokane for 2021</span><a class="headerlink" href="#id8" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
</section>
<section id="working-with-date-times-and-time-deltas">
<h2><span class="section-number">16.2. </span>Working with date-times and time-deltas<a class="headerlink" href="#working-with-date-times-and-time-deltas" title="Permalink to this heading">#</a></h2>
<section id="representation-the-unix-epoch">
<h3><span class="section-number">16.2.1. </span>Representation: The UNIX epoch<a class="headerlink" href="#representation-the-unix-epoch" title="Permalink to this heading">#</a></h3>
<p><a class="reference external" href="https://numpy.org/doc/stable/reference/arrays.datetime.html"><code class="docutils literal notranslate"><span class="pre">numpy.datetime64</span></code></a> is a type to represent date-times.
Usually, we will be creating dates from strings, for instance:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
    <span class="s2">&quot;1889-08-01&quot;</span><span class="p">,</span> <span class="s2">&quot;1970-01-01&quot;</span><span class="p">,</span> <span class="s2">&quot;1970-01-02&quot;</span><span class="p">,</span> <span class="s2">&quot;2021-12-31&quot;</span><span class="p">,</span> <span class="s2">&quot;today&quot;</span>
<span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;datetime64&quot;</span><span class="p">)</span>
<span class="n">d</span>
<span class="c1">## array([&#39;1889-08-01&#39;, &#39;1970-01-01&#39;, &#39;1970-01-02&#39;, &#39;2021-12-31&#39;,</span>
<span class="c1">##        &#39;2023-05-01&#39;], dtype=&#39;datetime64[D]&#39;)</span>
</pre></div>
</div>
<p>Similarly with date-times:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s2">&quot;1970-01-01T02:01:05&quot;</span><span class="p">,</span> <span class="s2">&quot;now&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;datetime64&quot;</span><span class="p">)</span>
<span class="n">dt</span>
<span class="c1">## array([&#39;1970-01-01T02:01:05&#39;, &#39;2023-05-01T04:49:38&#39;],</span>
<span class="c1">##       dtype=&#39;datetime64[s]&#39;)</span>
</pre></div>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Internally, the above are represented as
the number of days or seconds since the <em>UNIX Epoch</em>,
1970-01-01T00:00:00 in the UTC time zone.</p>
</div>
<p>Let us verify the above statement:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">d</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
<span class="c1">## array([-2.9372e+04,  0.0000e+00,  1.0000e+00,  1.8992e+04,  1.9478e+04])</span>
<span class="n">dt</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
<span class="c1">## array([7.26500000e+03, 1.68291658e+09])</span>
</pre></div>
</div>
<p>When we think about it for a while, this is exactly what we expected.</p>
<div class="proof proof-type-exercise" id="id9">

    <div class="proof-title">
        <span class="proof-type">Exercise 16.1</span>
        
    </div><div class="proof-content">
<p>(*) Write a regular expression that extracts
all dates in the YYYY-MM-DD format from a
(possibly long) string and converts them to <code class="docutils literal notranslate"><span class="pre">datetime64</span></code>.</p>
</div></div></section>
<section id="time-differences">
<h3><span class="section-number">16.2.2. </span>Time differences<a class="headerlink" href="#time-differences" title="Permalink to this heading">#</a></h3>
<p>Computing date-time differences (time-deltas) is possible thanks
to the <code class="docutils literal notranslate"><span class="pre">numpy.timedelta64</span></code> objects:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">d</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">)</span>  <span class="c1"># minus 1 Day</span>
<span class="c1">## array([&#39;1889-07-31&#39;, &#39;1969-12-31&#39;, &#39;1970-01-01&#39;, &#39;2021-12-30&#39;,</span>
<span class="c1">##        &#39;2023-04-30&#39;], dtype=&#39;datetime64[D]&#39;)</span>
<span class="n">dt</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="s2">&quot;h&quot;</span><span class="p">)</span>  <span class="c1"># plus 12 hours</span>
<span class="c1">## array([&#39;1970-01-01T14:01:05&#39;, &#39;2023-05-01T16:49:38&#39;],</span>
<span class="c1">##       dtype=&#39;datetime64[s]&#39;)</span>
</pre></div>
</div>
<p>Also, <strong class="command">numpy.arange</strong> (and <strong class="command">pandas.date_range</strong>)
can be used to generate sequences of equidistant
date-times:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">dates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="s2">&quot;1889-08-01&quot;</span><span class="p">,</span> <span class="s2">&quot;2022-01-01&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;datetime64[D]&quot;</span><span class="p">)</span>
<span class="n">dates</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>   <span class="c1"># preview</span>
<span class="c1">## array([&#39;1889-08-01&#39;, &#39;1889-08-02&#39;, &#39;1889-08-03&#39;], dtype=&#39;datetime64[D]&#39;)</span>
<span class="n">dates</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span>  <span class="c1"># preview</span>
<span class="c1">## array([&#39;2021-12-29&#39;, &#39;2021-12-30&#39;, &#39;2021-12-31&#39;], dtype=&#39;datetime64[D]&#39;)</span>
</pre></div>
</div>
</section>
<section id="date-times-in-data-frames">
<span id="sec-df-datetime"></span><h3><span class="section-number">16.2.3. </span>Date-times in data frames<a class="headerlink" href="#date-times-in-data-frames" title="Permalink to this heading">#</a></h3>
<p>Dates and date-times can be emplaced in <strong class="program">pandas</strong>
data frames:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">spokane</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span>
    <span class="n">date</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="s2">&quot;1889-08-01&quot;</span><span class="p">,</span> <span class="s2">&quot;2022-01-01&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;datetime64[D]&quot;</span><span class="p">),</span>
    <span class="n">temp</span><span class="o">=</span><span class="n">temps</span>
<span class="p">))</span>
<span class="n">spokane</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
<span class="c1">##         date  temp</span>
<span class="c1">## 0 1889-08-01  21.1</span>
<span class="c1">## 1 1889-08-02  20.8</span>
<span class="c1">## 2 1889-08-03  22.2</span>
<span class="c1">## 3 1889-08-04  21.7</span>
<span class="c1">## 4 1889-08-05  18.3</span>
</pre></div>
</div>
<p>Interestingly, if we ask the <code class="docutils literal notranslate"><span class="pre">date</span></code> column
to become the data frame’s <code class="docutils literal notranslate"><span class="pre">index</span></code> (i.e., row labels),
we will be able select date ranges quite easily
with <strong class="command">loc</strong><code class="code docutils literal notranslate"><span class="pre">[...]</span></code> and string slices
(refer to the manual of <code class="docutils literal notranslate"><span class="pre">pandas.DateTimeIndex</span></code> for more details).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">spokane</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;2021-12-25&quot;</span><span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="c1">##         date  temp</span>
<span class="c1">## 0 2021-12-25  -1.4</span>
<span class="c1">## 1 2021-12-26  -5.0</span>
<span class="c1">## 2 2021-12-27  -9.4</span>
<span class="c1">## 3 2021-12-28 -12.8</span>
<span class="c1">## 4 2021-12-29 -12.2</span>
<span class="c1">## 5 2021-12-30 -11.4</span>
<span class="c1">## 6 2021-12-31 -11.4</span>
</pre></div>
</div>
<div class="proof proof-type-example" id="id10">

    <div class="proof-title">
        <span class="proof-type">Example 16.2</span>
        
    </div><div class="proof-content">
<p>Based on the above, we can plot the data for the last five years quite
easily; see <a class="reference internal" href="#fig-spokane-5-linechart"><span class="std std-numref">Figure 16.3</span></a>.
Note that the x-axis labels are generated automatically.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">spokane</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;2017-01-01&quot;</span><span class="p">:,</span> <span class="s2">&quot;temp&quot;</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<figure class="align-default" id="id11">
<span id="fig-spokane-5-linechart"></span><img alt="../_images/spokane-5-linechart-5.png" src="../_images/spokane-5-linechart-5.png" />
<figcaption>
<p><span class="caption-number">Figure 16.3 </span><span class="caption-text">Line chart of midrange daily temperatures in Spokane for 2017–2021</span><a class="headerlink" href="#id11" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
</div></div><p>The <strong class="command">pandas.to_datetime</strong> function can also
convert arbitrarily formatted date strings,
e.g., <code class="docutils literal notranslate"><span class="pre">&quot;MM/DD/YYYY&quot;</span></code> or <code class="docutils literal notranslate"><span class="pre">&quot;DD.MM.YYYY&quot;</span></code> to <code class="docutils literal notranslate"><span class="pre">Series</span></code> of
<code class="docutils literal notranslate"><span class="pre">datetime64</span></code>s.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">dates</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;05.04.1991&quot;</span><span class="p">,</span> <span class="s2">&quot;14.07.2022&quot;</span><span class="p">,</span> <span class="s2">&quot;21.12.2042&quot;</span><span class="p">]</span>
<span class="n">dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">.%m.%Y&quot;</span><span class="p">))</span>
<span class="n">dates</span>
<span class="c1">## 0   1991-04-05</span>
<span class="c1">## 1   2022-07-14</span>
<span class="c1">## 2   2042-12-21</span>
<span class="c1">## dtype: datetime64[ns]</span>
</pre></div>
</div>
<div class="proof proof-type-exercise" id="id12">

    <div class="proof-title">
        <span class="proof-type">Exercise 16.3</span>
        
    </div><div class="proof-content">
<p>From the <a class="reference external" href="https://github.com/gagolews/teaching-data/raw/master/marek/birth_dates.csv"><code class="docutils literal notranslate"><span class="pre">birth_dates</span></code></a> dataset, select all people less than 18 years old
(as of the current day).</p>
</div></div><p>Several date-time functions and related properties can
be referred to via the <strong class="command">pandas.Series.dt</strong> accessor
(similarly to <strong class="command">pandas.Series.str</strong> discussed in <a class="reference internal" href="510-text.html#chap-text"><span class="std std-numref">Chapter 14</span></a>).
In particular, they deliver a convenient means for extracting different
date or time fields, such as
<code class="docutils literal notranslate"><span class="pre">date</span></code>, <code class="docutils literal notranslate"><span class="pre">time</span></code>, <code class="docutils literal notranslate"><span class="pre">year</span></code>, <code class="docutils literal notranslate"><span class="pre">month</span></code>, <code class="docutils literal notranslate"><span class="pre">day</span></code>, <code class="docutils literal notranslate"><span class="pre">dayofyear</span></code>,
<code class="docutils literal notranslate"><span class="pre">hour</span></code>, <code class="docutils literal notranslate"><span class="pre">minute</span></code>, <code class="docutils literal notranslate"><span class="pre">second</span></code>, etc.
For instance:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">dates_ymd</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span>
    <span class="n">year</span>  <span class="o">=</span> <span class="n">dates</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>
    <span class="n">month</span> <span class="o">=</span> <span class="n">dates</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="p">,</span>
    <span class="n">day</span>   <span class="o">=</span> <span class="n">dates</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">day</span>
<span class="p">))</span>
<span class="n">dates_ymd</span>
<span class="c1">##    year  month  day</span>
<span class="c1">## 0  1991      4    5</span>
<span class="c1">## 1  2022      7   14</span>
<span class="c1">## 2  2042     12   21</span>
</pre></div>
</div>
<p>In some contexts, converting date-time objects
to strings following custom formats might also be noteworthy:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">dates</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">.%m.%Y&quot;</span><span class="p">)</span>
<span class="c1">## 0    05.04.1991</span>
<span class="c1">## 1    14.07.2022</span>
<span class="c1">## 2    21.12.2042</span>
<span class="c1">## dtype: object</span>
</pre></div>
</div>
<p>Interestingly, <strong class="command">pandas.to_datetime</strong> can also convert data frames
with columns named <code class="docutils literal notranslate"><span class="pre">year</span></code>, <code class="docutils literal notranslate"><span class="pre">month</span></code>, <code class="docutils literal notranslate"><span class="pre">day</span></code>, etc., back to date-time
objects directly:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">dates_ymd</span><span class="p">)</span>
<span class="c1">## 0   1991-04-05</span>
<span class="c1">## 1   2022-07-14</span>
<span class="c1">## 2   2042-12-21</span>
<span class="c1">## dtype: datetime64[ns]</span>
</pre></div>
</div>
<div class="proof proof-type-example" id="id13">

    <div class="proof-title">
        <span class="proof-type">Example 16.4</span>
        
    </div><div class="proof-content">
<p>Let us extract the month and year parts of dates
to compute the average monthly temperatures
it the last 50-ish years:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">spokane</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;1970&quot;</span><span class="p">:,</span> <span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">mean_monthly_temps</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span>
    <span class="n">x</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">),</span>
    <span class="n">x</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;month&quot;</span><span class="p">)</span>
<span class="p">])</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span>
<span class="n">mean_monthly_temps</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># preview</span>
<span class="c1">## month   1    2    3    4     5     6     7     8     9    10   11   12</span>
<span class="c1">## year                                                                  </span>
<span class="c1">## 1970  -3.4  2.3  2.8  5.3  12.7  19.0  22.5  21.2  12.3  7.2  2.2 -2.4</span>
<span class="c1">## 1971  -0.1  0.8  1.7  7.4  13.5  14.6  21.0  23.4  12.9  6.8  1.9 -3.5</span>
<span class="c1">## 1972  -5.2 -0.7  5.2  5.6  13.8  16.6  20.0  21.7  13.0  8.4  3.5 -3.7</span>
<span class="c1">## 1973  -2.8  1.6  5.0  7.8  13.6  16.7  21.8  20.6  15.4  8.4  0.9  0.7</span>
<span class="c1">## 1974  -4.4  1.8  3.6  8.0  10.1  18.9  19.9  20.1  15.8  8.9  2.4 -0.8</span>
</pre></div>
</div>
<p><a class="reference internal" href="#fig-mean-monthly-temps"><span class="std std-numref">Figure 16.4</span></a> depicts these data on a heat map.
We rediscover the ultimate truth that winters are cold, whereas in the
summertime the living is easy, what a wonderful world.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">mean_monthly_temps</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<figure class="align-default" id="id14">
<span id="fig-mean-monthly-temps"></span><img alt="../_images/mean-monthly-temps-7.png" src="../_images/mean-monthly-temps-7.png" />
<figcaption>
<p><span class="caption-number">Figure 16.4 </span><span class="caption-text">Average monthly temperatures</span><a class="headerlink" href="#id14" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
</div></div></section>
</section>
<section id="basic-operations">
<h2><span class="section-number">16.3. </span>Basic operations<a class="headerlink" href="#basic-operations" title="Permalink to this heading">#</a></h2>
<section id="iterated-differences-and-cumulative-sums-revisited">
<span id="sec-diff-ts"></span><h3><span class="section-number">16.3.1. </span>Iterated differences and cumulative sums revisited<a class="headerlink" href="#iterated-differences-and-cumulative-sums-revisited" title="Permalink to this heading">#</a></h3>
<p>Recall from <a class="reference internal" href="220-transform-vector.html#sec-cumsum"><span class="std std-numref">Section 5.5.1</span></a> the <strong class="command">numpy.diff</strong> function
and its almost-inverse, <strong class="command">numpy.cumsum</strong>.
The former can turn a time series into a vector of <em>relative changes</em>
(<em>deltas</em>), <span class="math notranslate nohighlight">\(\Delta_i=x_{i+1}-x_i\)</span>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">temps</span><span class="p">[</span><span class="o">-</span><span class="mi">7</span><span class="p">:]</span>  <span class="c1"># last 7 days</span>
<span class="n">x</span>
<span class="c1">## array([ -1.4,  -5. ,  -9.4, -12.8, -12.2, -11.4, -11.4])</span>
</pre></div>
</div>
<p>The iterated differences (deltas) are:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">d</span>
<span class="c1">## array([-3.6, -4.4, -3.4,  0.6,  0.8,  0. ])</span>
</pre></div>
</div>
<p>For instance, between the second and the first day of the last week,
the midrange temperature dropped by -3.6°C.</p>
<div style="margin-top: 1em"></div><p>The other way around, here the cumulative sums of the deltas:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
<span class="c1">## array([ -3.6,  -8. , -11.4, -10.8, -10. , -10. ])</span>
</pre></div>
</div>
<p>This turned deltas back to a shifted version of the original series.
But we will need the first (root) observation therefrom
to restore the dataset in full:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
<span class="c1">## array([ -1.4,  -5. ,  -9.4, -12.8, -12.2, -11.4, -11.4])</span>
</pre></div>
</div>
<div class="proof proof-type-exercise" id="id15">

    <div class="proof-title">
        <span class="proof-type">Exercise 16.5</span>
        
    </div><div class="proof-content">
<p>Consider the <a class="reference external" href="https://github.com/gagolews/teaching-data/raw/master/marek/euraud-20200101-20200630-no-na.txt"><code class="docutils literal notranslate"><span class="pre">euraud-20200101-20200630-no-na</span></code></a> dataset
which lists daily EUR/AUD exchange rates in the first half of 2020 (remember
COVID-19?), with missing observations removed. Using <strong class="command">numpy.diff</strong>,
compute the minimum, median, average, and maximum daily price <em>changes</em>.
Also, draw a box and whisker plot for these deltas.</p>
</div></div><div class="proof proof-type-example" id="id16">

    <div class="proof-title">
        <span class="proof-type">Example 16.6</span>
        
    </div><div class="proof-content">
<p>(*)
The exponential distribution family is sometimes used
for the modelling of times between different events (deltas).
It might be a sensible choice under the assumption that a system generates
a constant number of events on average and that they occur
independently of each other,
e.g., for the times between requests to a cloud service during peak hours,
wait times for the next pedestrian to appear at a crossing near
the Southern Cross Station in Melbourne, or the amount of time
it takes a bank teller to interact with a customer
(there is a whole branch of applied mathematics
called queuing theory that deals with this type of modelling).</p>
<div style="margin-top: 1em"></div><p>An exponential family is identified by the scale parameter
<span class="math notranslate nohighlight">\(s &gt; 0\)</span>, being at the same time its expected value.
The probability density function of Exp(<em>s</em>) is given for <span class="math notranslate nohighlight">\(x\ge 0\)</span> by:</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[
f(x) = \tfrac{1}{s} e^{-x/s},
\]</div>
</div>
<p>and <span class="math notranslate nohighlight">\(f(x)=0\)</span> otherwise.
We need to be careful: some textbooks choose the parametrisation by
<span class="math notranslate nohighlight">\(\lambda=1/s\)</span> instead of <span class="math notranslate nohighlight">\(s\)</span>. The <strong class="program">scipy</strong> package also uses this
convention.</p>
<div style="margin-top: 1em"></div><p>Here is a pseudorandom sample where there are five events per
minute on average:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>
<span class="n">λ</span> <span class="o">=</span> <span class="mi">60</span><span class="o">/</span><span class="mi">5</span>  <span class="c1"># 5 events per 60 seconds on average</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">expon</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">1200</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">λ</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">d</span><span class="p">[:</span><span class="mi">8</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># preview</span>
<span class="c1">## array([14.307,  4.045,  3.087,  9.617, 15.253,  6.601, 47.412, 13.856])</span>
</pre></div>
</div>
<p>This gave us the wait times between the events, in seconds.</p>
<p>A natural sample estimator of the scale parameter is:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
<span class="c1">## 11.839894504211724</span>
</pre></div>
</div>
<p>The result is close to what we <em>expected</em>, i.e., <span class="math notranslate nohighlight">\(s=12\)</span> seconds between
the events.</p>
<p>We can convert the above to date-time
(starting at a fixed calendar date) as follows.
Note that we will measure the deltas in milliseconds so that we do not loose
precision; <code class="docutils literal notranslate"><span class="pre">datetime64</span></code> is based on integers, not floating-point numbers.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">t0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s2">&quot;2022-01-01T00:00:00&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;datetime64[ms]&quot;</span><span class="p">)</span>
<span class="n">d_ms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">d</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>  <span class="c1"># in milliseconds</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">t0</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">d_ms</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;timedelta64[ms]&quot;</span><span class="p">)</span>
<span class="n">t</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span>  <span class="c1"># preview</span>
<span class="c1">## array([&#39;2022-01-01T00:00:14.307&#39;, &#39;2022-01-01T00:00:18.352&#39;,</span>
<span class="c1">##        &#39;2022-01-01T00:00:21.439&#39;, &#39;2022-01-01T00:00:31.056&#39;,</span>
<span class="c1">##        &#39;2022-01-01T00:00:46.309&#39;, &#39;2022-01-01T00:00:52.910&#39;,</span>
<span class="c1">##        &#39;2022-01-01T00:01:40.322&#39;, &#39;2022-01-01T00:01:54.178&#39;],</span>
<span class="c1">##       dtype=&#39;datetime64[ms]&#39;)</span>
<span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>  <span class="c1"># preview</span>
<span class="c1">## array([&#39;2022-01-01T03:56:45.312&#39;, &#39;2022-01-01T03:56:47.890&#39;],</span>
<span class="c1">##       dtype=&#39;datetime64[ms]&#39;)</span>
</pre></div>
</div>
<p>As an exercise, let us apply binning and
count how many events occur in each hour:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>  <span class="c1"># four 1-hour interval (five time points)</span>
    <span class="s2">&quot;2022-01-01T00:00:00&quot;</span><span class="p">,</span> <span class="s2">&quot;2022-01-01T05:00:00&quot;</span><span class="p">,</span>
    <span class="mi">1000</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="p">,</span>  <span class="c1"># number of milliseconds in 1 hour</span>
    <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;datetime64[ms]&quot;</span>
<span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">b</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="c1">## array([305, 300, 274, 321])</span>
</pre></div>
</div>
<p>We expect 5 events per second, i.e., 300 of them per hour.
On a side note, from a course in statistics
we know that for exponential inter-event times,
the number of events per unit of time follows a Poisson
distribution.</p>
</div></div><div class="proof proof-type-exercise" id="id17">

    <div class="proof-title">
        <span class="proof-type">Exercise 16.7</span>
        
    </div><div class="proof-content">
<p>(*)
Consider the <a class="reference external" href="https://github.com/gagolews/teaching-data/raw/master/marek/wait_times.txt"><code class="docutils literal notranslate"><span class="pre">wait_times</span></code></a> dataset
that gives the times between some consecutive events, in seconds.
Estimate the event rate per hour. Draw a histogram representing the number
of events per hour.</p>
</div></div><div class="proof proof-type-exercise" id="id18">

    <div class="proof-title">
        <span class="proof-type">Exercise 16.8</span>
        
    </div><div class="proof-content">
<p>(*) Consider the <a class="reference external" href="https://github.com/gagolews/teaching-data/raw/master/marek/btcusd_ohlcv_2021_dates.csv"><code class="docutils literal notranslate"><span class="pre">btcusd_ohlcv_2021_dates</span></code></a>
dataset which gives the daily BTC/USD exchange rates in 2021:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">btc</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;https://raw.githubusercontent.com/gagolews/&quot;</span> <span class="o">+</span>
    <span class="s2">&quot;teaching-data/master/marek/btcusd_ohlcv_2021_dates.csv&quot;</span><span class="p">,</span>
    <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;#&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Close&quot;</span><span class="p">]]</span>
<span class="n">btc</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">btc</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;datetime64[D]&quot;</span><span class="p">)</span>
<span class="n">btc</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
<span class="c1">##          Date      Close</span>
<span class="c1">## 0  2021-01-01  29374.152</span>
<span class="c1">## 1  2021-01-02  32127.268</span>
<span class="c1">## 2  2021-01-03  32782.023</span>
<span class="c1">## 3  2021-01-04  31971.914</span>
<span class="c1">## 4  2021-01-05  33992.430</span>
<span class="c1">## 5  2021-01-06  36824.363</span>
<span class="c1">## 6  2021-01-07  39371.043</span>
<span class="c1">## 7  2021-01-08  40797.609</span>
<span class="c1">## 8  2021-01-09  40254.547</span>
<span class="c1">## 9  2021-01-10  38356.441</span>
<span class="c1">## 10 2021-01-11  35566.656</span>
<span class="c1">## 11 2021-01-12  33922.961</span>
</pre></div>
</div>
<p>Write a function that converts it to a <em>lagged representation</em>, being a
convenient form for some machine learning algorithms.</p>
<ol class="arabic simple">
<li><p>Add the <code class="docutils literal notranslate"><span class="pre">Change</span></code> column that gives by how much the price changed
since the previous day.</p></li>
<li><p>Add the <code class="docutils literal notranslate"><span class="pre">Dir</span></code> column indicating if the change was positive or negative.</p></li>
<li><p>Add the <code class="docutils literal notranslate"><span class="pre">Lag1</span></code>, …, <code class="docutils literal notranslate"><span class="pre">Lag5</span></code> columns which give the <code class="docutils literal notranslate"><span class="pre">Change</span></code>s in
the five preceding days.</p></li>
</ol>
<p>The first few rows of the resulting data frame should look like this
(assuming we do not want any missing values):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">##       Date Close   Change Dir     Lag1     Lag2    Lag3    Lag4    Lag5</span>
<span class="c1">## 2021-01-07 39371  2546.68 inc  2831.93  2020.52 -810.11  654.76 2753.12</span>
<span class="c1">## 2021-01-08 40798  1426.57 inc  2546.68  2831.93 2020.52 -810.11  654.76</span>
<span class="c1">## 2021-01-09 40255  -543.06 dec  1426.57  2546.68 2831.93 2020.52 -810.11</span>
<span class="c1">## 2021-01-10 38356 -1898.11 dec  -543.06  1426.57 2546.68 2831.93 2020.52</span>
<span class="c1">## 2021-01-11 35567 -2789.78 dec -1898.11  -543.06 1426.57 2546.68 2831.93</span>
<span class="c1">## 2021-01-12 33923 -1643.69 dec -2789.78 -1898.11 -543.06 1426.57 2546.68</span>
</pre></div>
</div>
<p>In the 6th row (representing 2021-01-12),
<code class="docutils literal notranslate"><span class="pre">Lag1</span></code> corresponds to <code class="docutils literal notranslate"><span class="pre">Change</span></code> on 2021-01-11,
<code class="docutils literal notranslate"><span class="pre">Lag2</span></code> gives the <code class="docutils literal notranslate"><span class="pre">Change</span></code> on 2021-01-10, and so forth.</p>
<p>To spice things up, make sure your code can generate any number
(as defined by another parameter to the function) of lagged variables.</p>
</div></div></section>
<section id="smoothing-with-moving-averages">
<h3><span class="section-number">16.3.2. </span>Smoothing with moving averages<a class="headerlink" href="#smoothing-with-moving-averages" title="Permalink to this heading">#</a></h3>
<p>With time series it makes sense to consider processing whole batches of
consecutive points, because there is a time dependence between them.
In particular, we can consider computing different
aggregates inside <em>rolling windows</em> of a particular size.
For instance, the <em><span class="math notranslate nohighlight">\(k\)</span>-moving average</em> of a given sequence
<span class="math notranslate nohighlight">\((x_1, x_2, \dots, x_n)\)</span> is a vector <span class="math notranslate nohighlight">\((y_1, y_2, \dots, y_{n-k+1})\)</span>
such that:</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[
y_i = \frac{1}{k}\left( x_{i}+x_{i+1}+\dots+x_{i+k-1} \right)
= \frac{1}{k} \sum_{j=1}^k x_{i+j-1},
\]</div>
</div>
<p>i.e., the arithmetic mean of <span class="math notranslate nohighlight">\(k\le n\)</span> consecutive observations
starting at <span class="math notranslate nohighlight">\(x_i\)</span>.</p>
<div style="margin-top: 1em"></div><p>For example, here are the temperatures in the last 7 days of
December 2011:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">spokane</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">7</span><span class="p">:,</span> <span class="p">:]</span>
<span class="n">x</span>
<span class="c1">##             temp</span>
<span class="c1">## date            </span>
<span class="c1">## 2021-12-25  -1.4</span>
<span class="c1">## 2021-12-26  -5.0</span>
<span class="c1">## 2021-12-27  -9.4</span>
<span class="c1">## 2021-12-28 -12.8</span>
<span class="c1">## 2021-12-29 -12.2</span>
<span class="c1">## 2021-12-30 -11.4</span>
<span class="c1">## 2021-12-31 -11.4</span>
</pre></div>
</div>
<p>The 3-moving (rolling) average:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">x</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="c1">##              temp</span>
<span class="c1">## date             </span>
<span class="c1">## 2021-12-25    NaN</span>
<span class="c1">## 2021-12-26  -5.27</span>
<span class="c1">## 2021-12-27  -9.07</span>
<span class="c1">## 2021-12-28 -11.47</span>
<span class="c1">## 2021-12-29 -12.13</span>
<span class="c1">## 2021-12-30 -11.67</span>
<span class="c1">## 2021-12-31    NaN</span>
</pre></div>
</div>
<p>We get, in this order: the mean of the first three observations;
the mean of the 2nd, 3rd, and 4th items;
then the mean of the 3rd, 4th, and 5th; and so forth.
Notice that the observations were centred in such a way
that we have the same number of missing values at the start
and end of the series.
This way, we treat the first 3-day moving average
(the average of the temperatures on the first three days) as representative
of the 2nd day.</p>
<p>And now for something completely different; the 5-moving average:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">x</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="c1">##              temp</span>
<span class="c1">## date             </span>
<span class="c1">## 2021-12-25    NaN</span>
<span class="c1">## 2021-12-26    NaN</span>
<span class="c1">## 2021-12-27  -8.16</span>
<span class="c1">## 2021-12-28 -10.16</span>
<span class="c1">## 2021-12-29 -11.44</span>
<span class="c1">## 2021-12-30    NaN</span>
<span class="c1">## 2021-12-31    NaN</span>
</pre></div>
</div>
<div style="margin-top: 1em"></div><p>Applying the moving average has the nice effect of
<em>smoothing</em> out all kinds of broadly conceived noise.
To illustrate this, compare
the temperature data for the last five years
in <a class="reference internal" href="#fig-spokane-5-linechart"><span class="std std-numref">Figure 16.3</span></a> to their averaged versions in
<a class="reference internal" href="#fig-spokane-ma-linechart"><span class="std std-numref">Figure 16.5</span></a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">spokane</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;2017-01-01&quot;</span><span class="p">:,</span> <span class="s2">&quot;temp&quot;</span><span class="p">]</span>
<span class="n">x30</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">x100</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x30</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;30-day moving average&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x100</span><span class="p">,</span> <span class="s2">&quot;r--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;100-day moving average&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<figure class="align-default" id="id19">
<span id="fig-spokane-ma-linechart"></span><img alt="../_images/spokane-ma-linechart-9.png" src="../_images/spokane-ma-linechart-9.png" />
<figcaption>
<p><span class="caption-number">Figure 16.5 </span><span class="caption-text">Line chart of 30- and 100-moving averages of the midrange daily temperatures in Spokane for 2017-2021</span><a class="headerlink" href="#id19" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<div class="proof proof-type-exercise" id="id20">

    <div class="proof-title">
        <span class="proof-type">Exercise 16.9</span>
        
    </div><div class="proof-content">
<p>(*) Other aggregation functions can be applied in rolling windows as well.
Draw, in the same figure,
the plots of the 1-year moving minimums, medians, and maximums.</p>
</div></div></section>
<section id="detecting-trends-and-seasonal-patterns">
<h3><span class="section-number">16.3.3. </span>Detecting trends and seasonal patterns<a class="headerlink" href="#detecting-trends-and-seasonal-patterns" title="Permalink to this heading">#</a></h3>
<p>Thanks to windowed aggregation, we can also detect general trends
(when using longish windows). For instance, below we compute
the 10-year moving averages for the last 50-odd years’ worth
of data:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">spokane</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;1970-01-01&quot;</span><span class="p">:,</span> <span class="s2">&quot;temp&quot;</span><span class="p">]</span>
<span class="n">x10y</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">3653</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
<p>Based on this, we can compute the detrended series:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">xd</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">x10y</span>
</pre></div>
</div>
<p>Seasonal patterns can be revealed by
smoothening out the detrended version of the data,
e.g., using a 1-year moving average:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">xd1y</span> <span class="o">=</span> <span class="n">xd</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">365</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
<p><a class="reference internal" href="#fig-spokane-ma-trends"><span class="std std-numref">Figure 16.6</span></a> illustrates this.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x10y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;trend&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xd1y</span><span class="p">,</span> <span class="s2">&quot;r--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;seasonal pattern&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<figure class="align-default" id="id21">
<span id="fig-spokane-ma-trends"></span><img alt="../_images/spokane-ma-trends-11.png" src="../_images/spokane-ma-trends-11.png" />
<figcaption>
<p><span class="caption-number">Figure 16.6 </span><span class="caption-text">Trend and seasonal pattern for the Spokane temperatures in recent years</span><a class="headerlink" href="#id21" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>Also, if we know the length of the seasonal pattern (in our case,
365-ish days), we can draw a seasonal plot, where we have a separate
curve for each season (here: year) and where all the series share
the same x-axis (here: the day of the year);
see <a class="reference internal" href="#fig-spokane-seasonal"><span class="std std-numref">Figure 16.7</span></a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">cm</span>
<span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s2">&quot;coolwarm&quot;</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">spokane</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;1970-01-01&quot;</span><span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1970</span><span class="p">,</span> <span class="mi">2022</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>                     <span class="c1"># selected years only</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">dayofyear</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">temp</span><span class="p">,</span>
        <span class="n">c</span><span class="o">=</span><span class="n">cmap</span><span class="p">((</span><span class="n">year</span><span class="o">-</span><span class="mi">1970</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2021</span><span class="o">-</span><span class="mi">1970</span><span class="p">)),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="n">year</span> <span class="k">if</span> <span class="n">year</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
<span class="n">avex</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">dayofyear</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">avex</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">avex</span><span class="p">,</span> <span class="s2">&quot;g-&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Average&quot;</span><span class="p">)</span>     <span class="c1"># all years</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Day of year&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Temperature&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<figure class="align-default" id="id22">
<span id="fig-spokane-seasonal"></span><img alt="../_images/spokane-seasonal-13.png" src="../_images/spokane-seasonal-13.png" />
<figcaption>
<p><span class="caption-number">Figure 16.7 </span><span class="caption-text">Seasonal plot:  Temperatures in Spokane vs the day of the year; years between 1970 and 2021</span><a class="headerlink" href="#id22" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<div class="proof proof-type-exercise" id="id23">

    <div class="proof-title">
        <span class="proof-type">Exercise 16.10</span>
        
    </div><div class="proof-content">
<p>Draw a similar plot for the whole data range,
i.e., 1889–2021.</p>
</div></div><div class="proof proof-type-exercise" id="id24">

    <div class="proof-title">
        <span class="proof-type">Exercise 16.11</span>
        
    </div><div class="proof-content">
<p>Try using <strong class="command">pd.Series.dt.strftime</strong> with a custom formatter instead
of <code class="docutils literal notranslate"><span class="pre">pd.Series.dt.dayofyear</span></code>.</p>
</div></div></section>
<section id="imputing-missing-values">
<h3><span class="section-number">16.3.4. </span>Imputing missing values<a class="headerlink" href="#imputing-missing-values" title="Permalink to this heading">#</a></h3>
<p>Missing values in time series can be imputed based on the information
from the neighbouring non-missing observations.
After all, it is usually the case that, e.g.,
today’s weather is “similar” to yesterday’s and tomorrow’s.</p>
<p>The most straightforward ways for dealing with missing values
in time series are:</p>
<ul class="simple">
<li><p><em>forward-fill</em> – propagate the last non-missing observation,</p></li>
<li><p><em>backward-fill</em> – get the next non-missing value,</p></li>
<li><p><em>linearly interpolate between two adjacent non-missing values</em> –
in particular, a single missing value will be replaced
by the average of its neighbours.</p></li>
</ul>
<div class="proof proof-type-example" id="id25">

    <div class="proof-title">
        <span class="proof-type">Example 16.12</span>
        
    </div><div class="proof-content">
<p>The classic <a class="reference external" href="https://github.com/gagolews/teaching-data/raw/master/r/air_quality_1973.csv"><code class="docutils literal notranslate"><span class="pre">air_quality_1973</span></code></a> dataset gives some
daily air quality measurements in New York, between May and September 1973.
Let us impute the first few observations in the solar radiation column:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">air</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;https://raw.githubusercontent.com/gagolews/&quot;</span> <span class="o">+</span>
    <span class="s2">&quot;teaching-data/master/r/air_quality_1973.csv&quot;</span><span class="p">,</span>
    <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;#&quot;</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">air</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;Solar.R&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">12</span><span class="p">]</span>
<span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span>
    <span class="n">original</span><span class="o">=</span><span class="n">x</span><span class="p">,</span>
    <span class="n">ffilled</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;ffill&quot;</span><span class="p">),</span>
    <span class="n">bfilled</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;bfill&quot;</span><span class="p">),</span>
    <span class="n">interpolated</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">)</span>
<span class="p">))</span>
<span class="c1">##     original  ffilled  bfilled  interpolated</span>
<span class="c1">## 0      190.0    190.0    190.0    190.000000</span>
<span class="c1">## 1      118.0    118.0    118.0    118.000000</span>
<span class="c1">## 2      149.0    149.0    149.0    149.000000</span>
<span class="c1">## 3      313.0    313.0    313.0    313.000000</span>
<span class="c1">## 4        NaN    313.0    299.0    308.333333</span>
<span class="c1">## 5        NaN    313.0    299.0    303.666667</span>
<span class="c1">## 6      299.0    299.0    299.0    299.000000</span>
<span class="c1">## 7       99.0     99.0     99.0     99.000000</span>
<span class="c1">## 8       19.0     19.0     19.0     19.000000</span>
<span class="c1">## 9      194.0    194.0    194.0    194.000000</span>
<span class="c1">## 10       NaN    194.0    256.0    225.000000</span>
<span class="c1">## 11     256.0    256.0    256.0    256.000000</span>
</pre></div>
</div>
</div></div><div class="proof proof-type-exercise" id="id26">

    <div class="proof-title">
        <span class="proof-type">Exercise 16.13</span>
        
    </div><div class="proof-content">
<p>(*) With the <a class="reference external" href="https://github.com/gagolews/teaching-data/raw/master/marek/air_quality_2018.csv.gz"><code class="docutils literal notranslate"><span class="pre">air_quality_2018</span></code></a>
dataset:</p>
<ol class="arabic">
<li><p>Based on the hourly observations, compute the daily mean PM2.5
measurements for Melbourne CBD and Morwell South.</p>
<p>For Melbourne CBD, if some hourly measurement is missing,
linearly interpolate between the preceding and following non-missing
data, e.g., a PM2.5 sequence of <code class="docutils literal notranslate"><span class="pre">[...,</span> <span class="pre">10,</span> <span class="pre">NaN,</span> <span class="pre">NaN,</span> <span class="pre">40,</span> <span class="pre">...]</span></code>
(you need to manually add the <code class="docutils literal notranslate"><span class="pre">NaN</span></code> rows to the dataset)
should be transformed to <code class="docutils literal notranslate"><span class="pre">[...,</span> <span class="pre">10,</span> <span class="pre">20,</span> <span class="pre">30,</span> <span class="pre">40,</span> <span class="pre">...]</span></code>.</p>
<p>For Morwell South, impute the readings with the averages
of the records in the nearest air quality stations,
which are located in Morwell East, Moe, Churchill, and Traralgon.</p>
</li>
<li><p>Present the daily mean PM2.5 measurements for Melbourne CBD
and Morwell South on a single plot.
The x-axis labels should be human-readable and intuitive.</p></li>
<li><p>For the Melbourne data, determine the number of days where
the average PM2.5 was greater than in the preceding day.</p></li>
<li><p>Find five most air-polluted days for Melbourne.</p></li>
</ol>
</div></div></section>
<section id="plotting-multidimensional-time-series">
<h3><span class="section-number">16.3.5. </span>Plotting multidimensional time series<a class="headerlink" href="#plotting-multidimensional-time-series" title="Permalink to this heading">#</a></h3>
<p>Multidimensional time series stored in the form of
an <em>n</em>-by-<em>m</em> matrix are best viewed as <em>m</em> time series –
possibly but not necessarily related to each other –
all sampled at the same <em>n</em> points in time
(e.g., <em>m</em> different stocks on <em>n</em> consecutive days).</p>
<p>Consider the currency exchange rates
for the first half of 2020:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">eurxxx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="s2">&quot;https://raw.githubusercontent.com/gagolews/&quot;</span> <span class="o">+</span>
    <span class="s2">&quot;teaching-data/master/marek/eurxxx-20200101-20200630-no-na.csv&quot;</span><span class="p">,</span>
    <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
<span class="n">eurxxx</span><span class="p">[:</span><span class="mi">6</span><span class="p">,</span> <span class="p">:]</span>  <span class="c1"># preview</span>
<span class="c1">## array([[1.6006 , 7.7946 , 0.84828, 4.2544 ],</span>
<span class="c1">##        [1.6031 , 7.7712 , 0.85115, 4.2493 ],</span>
<span class="c1">##        [1.6119 , 7.8049 , 0.85215, 4.2415 ],</span>
<span class="c1">##        [1.6251 , 7.7562 , 0.85183, 4.2457 ],</span>
<span class="c1">##        [1.6195 , 7.7184 , 0.84868, 4.2429 ],</span>
<span class="c1">##        [1.6193 , 7.7011 , 0.85285, 4.2422 ]])</span>
</pre></div>
</div>
<p>This gives EUR/AUD
(how many Australian Dollars we pay for 1 Euro),
EUR/CNY (Chinese Yuans), EUR/GBP (British Pounds),
and EUR/PLN (Polish Złotys), in this order.
Let us draw the four time series; see <a class="reference internal" href="#fig-currency-abs"><span class="std std-numref">Figure 16.8</span></a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">dates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="s2">&quot;https://raw.githubusercontent.com/gagolews/&quot;</span> <span class="o">+</span>
    <span class="s2">&quot;teaching-data/master/marek/euraud-20200101-20200630-dates.txt&quot;</span><span class="p">,</span>
    <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;datetime64&quot;</span><span class="p">)</span>
<span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;AUD&quot;</span><span class="p">,</span> <span class="s2">&quot;CNY&quot;</span><span class="p">,</span> <span class="s2">&quot;GBP&quot;</span><span class="p">,</span> <span class="s2">&quot;PLN&quot;</span><span class="p">]</span>
<span class="n">styles</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;solid&quot;</span><span class="p">,</span> <span class="s2">&quot;dotted&quot;</span><span class="p">,</span> <span class="s2">&quot;dashed&quot;</span><span class="p">,</span> <span class="s2">&quot;dashdot&quot;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">eurxxx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">eurxxx</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="n">styles</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">))</span>  <span class="c1"># a bit lower</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<figure class="align-default" id="id27">
<span id="fig-currency-abs"></span><img alt="../_images/currency-abs-15.png" src="../_images/currency-abs-15.png" />
<figcaption>
<p><span class="caption-number">Figure 16.8 </span><span class="caption-text">EUR/AUD, EUR/CNY, EUR/GBP, and EUR/PLN exchange rates in the first half of 2020</span><a class="headerlink" href="#id27" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>Unfortunately, they are all on different scales.
This is why the plot is not necessarily readable.
It would be better to draw these time series on four separate plots
(compare the trellis plots in <a class="reference internal" href="430-group-by.html#sec-trellis"><span class="std std-numref">Section 12.2.5</span></a>).</p>
<p>Another idea is to depict the currency exchange rates
<em>relative</em> to the prices on some day,
say, the first one;
see <a class="reference internal" href="#fig-currency-rel"><span class="std std-numref">Figure 16.9</span></a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">eurxxx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">eurxxx</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">eurxxx</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span>
        <span class="n">ls</span><span class="o">=</span><span class="n">styles</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<figure class="align-default" id="id28">
<span id="fig-currency-rel"></span><img alt="../_images/currency-rel-17.png" src="../_images/currency-rel-17.png" />
<figcaption>
<p><span class="caption-number">Figure 16.9 </span><span class="caption-text">EUR/AUD, EUR/CNY, EUR/GBP, and EUR/PLN exchange rates relative to the prices on the first day</span><a class="headerlink" href="#id28" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>This way, e.g., a relative EUR/AUD rate of ca. 1.15
in mid-March means that if an Aussie bought some
Euros on the first day, and then sold them three-ish months later,
they would have 15% more wealth
(the Euro become 15% stronger relative to AUD).</p>
<div style="margin-top: 1em"></div><div class="proof proof-type-exercise" id="id29">

    <div class="proof-title">
        <span class="proof-type">Exercise 16.14</span>
        
    </div><div class="proof-content">
<p>Based on the EUR/AUD and EUR/PLN records,
compute and plot the AUD/PLN as well as PLN/AUD rates.</p>
</div></div><div class="proof proof-type-exercise" id="id30">

    <div class="proof-title">
        <span class="proof-type">Exercise 16.15</span>
        
    </div><div class="proof-content">
<p>(*)
Draw the EUR/AUD and EUR/GBP rates on a single
plot, but where each series has
<a class="reference external" href="https://matplotlib.org/stable/gallery/subplots_axes_and_figures/secondary_axis.html">its own</a>
y-axis.</p>
</div></div><div class="proof proof-type-exercise" id="id31">

    <div class="proof-title">
        <span class="proof-type">Exercise 16.16</span>
        
    </div><div class="proof-content">
<p>(*)
Draw the EUR/xxx rates for your favourite currencies over a larger period.
Use
<a class="reference external" href="https://www.ecb.europa.eu/stats/policy_and_exchange_rates/euro_reference_exchange_rates/html/index.en.html">data</a>
downloaded from the European Central Bank. Add a few moving averages.
For each year, identify the lowest and the highest rate.</p>
</div></div></section>
<section id="candlestick-plots">
<h3><span class="section-number">16.3.6. </span>Candlestick plots (*)<a class="headerlink" href="#candlestick-plots" title="Permalink to this heading">#</a></h3>
<p>Consider the BTC/USD data for 2021:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">btcusd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="s2">&quot;https://raw.githubusercontent.com/gagolews/&quot;</span> <span class="o">+</span>
    <span class="s2">&quot;teaching-data/master/marek/btcusd_ohlcv_2021.csv&quot;</span><span class="p">,</span>
    <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
<span class="n">btcusd</span><span class="p">[:</span><span class="mi">6</span><span class="p">,</span> <span class="p">:</span><span class="mi">4</span><span class="p">]</span>  <span class="c1"># preview (we skip the Volume column for readability)</span>
<span class="c1">## array([[28994.01 , 29600.627, 28803.586, 29374.152],</span>
<span class="c1">##        [29376.455, 33155.117, 29091.182, 32127.268],</span>
<span class="c1">##        [32129.408, 34608.559, 32052.316, 32782.023],</span>
<span class="c1">##        [32810.949, 33440.219, 28722.756, 31971.914],</span>
<span class="c1">##        [31977.041, 34437.59 , 30221.188, 33992.43 ],</span>
<span class="c1">##        [34013.613, 36879.699, 33514.035, 36824.363]])</span>
</pre></div>
</div>
<p>This gives the open, high, low, and close (OHLC) prices on the 365
consecutive days, which is a common way to summarise daily rates.</p>
<p>The <a class="reference external" href="https://github.com/matplotlib/mplfinance"><strong class="program">mplfinance</strong></a>
package (<strong class="program">matplotlib-finance</strong>) features a few functions
related to the plotting of financial data.
Here, let us briefly describe the well-known candlestick plot.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mplfinance</span> <span class="k">as</span> <span class="nn">mpf</span>
<span class="n">dates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="s2">&quot;2021-01-01&quot;</span><span class="p">,</span> <span class="s2">&quot;2022-01-01&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;datetime64[D]&quot;</span><span class="p">)</span>
<span class="n">mpf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">btcusd</span><span class="p">,</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Open&quot;</span><span class="p">,</span> <span class="s2">&quot;High&quot;</span><span class="p">,</span> <span class="s2">&quot;Low&quot;</span><span class="p">,</span> <span class="s2">&quot;Close&quot;</span><span class="p">,</span> <span class="s2">&quot;Volume&quot;</span><span class="p">]</span>
<span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">dates</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">31</span><span class="p">,</span> <span class="p">:],</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;candle&quot;</span><span class="p">)</span>
<span class="c1"># plt.show() # not needed...</span>
</pre></div>
</div>
<figure class="align-default" id="id32">
<span id="fig-candlestick-plot"></span><img alt="../_images/candlestick-plot-19.png" src="../_images/candlestick-plot-19.png" />
<figcaption>
<p><span class="caption-number">Figure 16.10 </span><span class="caption-text">Candlestick plot for the BTC/USD exchange rates in January 2021</span><a class="headerlink" href="#id32" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p><a class="reference internal" href="#fig-candlestick-plot"><span class="std std-numref">Figure 16.10</span></a> depicts the January 2021 data.
Let us stress that this is not a box and whisker plot.
The candlestick body denotes the difference in the market opening
and the closing price. The wicks (shadows) give the range
(high to low).
White candlesticks represent bullish days – where the
closing rate is greater than the opening one (uptrend).
Black candles are bearish (decline).</p>
<div class="proof proof-type-exercise" id="id33">

    <div class="proof-title">
        <span class="proof-type">Exercise 16.17</span>
        
    </div><div class="proof-content">
<p>Draw the BTC/USD rates for the entire year and add the 10-day moving
averages.</p>
</div></div><div class="proof proof-type-exercise" id="id34">

    <div class="proof-title">
        <span class="proof-type">Exercise 16.18</span>
        
    </div><div class="proof-content">
<p>(*)
Draw a candlestick plot manually, without using
the <strong class="program">mplfinance</strong> package.
<em>Hint: <strong class="command">matplotlib.pyplot.fill</strong> might be helpful.</em></p>
</div></div><div class="proof proof-type-exercise" id="id35">

    <div class="proof-title">
        <span class="proof-type">Exercise 16.19</span>
        
    </div><div class="proof-content">
<p>(*)
Using <strong class="command">matplotlib.pyplot.fill_between</strong> add a semi-transparent
polygon that fills the area bounded between the Low
and High prices on all the days.</p>
</div></div></section>
</section>
<section id="further-reading">
<span id="sec-image"></span><h2><span class="section-number">16.4. </span>Further reading<a class="headerlink" href="#further-reading" title="Permalink to this heading">#</a></h2>
<p>Data science classically deals with
information that is or can be represented in tabular form
and where particular observations (which can be multidimensional)
are usually independent from but still to some extent similar to each other.
We often treat them as samples from different larger populations
which we would like to describe or compare at some level
of generality (think: health data on patients being
subject to two treatment plans that we wish
to evaluate).</p>
<p>From this perspective, time series are already quite distinct,
because there is some dependence
observed in the time domain: a price of a stock that we observe
today is influenced by what was happening yesterday.
There might also be some seasonal patterns or trends under the hood.
For a comprehensive introduction to forecasting; see
<span id="id3">[<a class="reference internal" href="999-bibliography.html#id34" title="Hyndman, R.J. and Athanasopoulos, G. (2021).  Forecasting: Principles and Practice. OTexts. URL: https://otexts.com/fpp3/.">52</a>, <a class="reference internal" href="999-bibliography.html#id35" title="Ord, J.K., Fildes, R., and Kourentzes, N. (2017).  Principles of Business Forecasting. Wessex Press.">70</a>]</span>.
Also, for data of this kind, employing statistical modelling
techniques (<em>stochastic processes</em>) can make a lot of sense;
see, e.g., <span id="id4">[<a class="reference internal" href="999-bibliography.html#id33" title="Tijms, H.C. (2003).  A First Course in Stochastic Models. Wiley.">84</a>]</span>.</p>
<div style="margin-top: 1em"></div><p><em>Signals</em> such as audio, images, and video are different,
because <em>structured randomness</em> does not play a dominant role there (unless
it is a noise that we would like to filter out).
Instead, what is happening in the frequency (think: perceiving
pitches when listening to music)
or spatial (seeing green grass and sky in a photo) domain
will play a key role there.</p>
<p>Signal processing thus requires a distinct set of tools,
e.g., Fourier analysis and finite impulse response (discrete
convolution) filters. This course obviously cannot be about everything
(also because it requires some more advanced calculus skills that we
did not assume the reader to have at this time);
but see, e.g., <span id="id5">[<a class="reference internal" href="999-bibliography.html#id32" title="Smith, S.W. (2002).  The Scientist and Engineer's Guide to Digital Signal Processing. Newnes. URL: https://www.dspguide.com/.">82</a>, <a class="reference internal" href="999-bibliography.html#id31" title="Steiglitz, K. (1996).  A Digital Signal Processing Primer: With Applications to Digital Audio and Computer Music. Pearson.">83</a>]</span>.</p>
<p>Nevertheless, keep in mind that these are not completely
independent domains. For example, we can extract various features of audio
signals (e.g., overall loudness, timbre, and danceability of each
recording in a large song database) and then treat them as tabular
data to be analysed using the techniques described in this course.
Moreover, machine learning (e.g., convolutional neural networks)
algorithms may also be used for tasks such as object detection
on images or optical character recognition;
see, e.g., <span id="id6">[<a class="reference internal" href="999-bibliography.html#id55" title="Goodfellow, I., Bengio, Y., and Courville, A. (2016).  Deep Learning. MIT Press. URL: https://www.deeplearningbook.org/.">42</a>]</span>.</p>
</section>
<section id="exercises">
<h2><span class="section-number">16.5. </span>Exercises<a class="headerlink" href="#exercises" title="Permalink to this heading">#</a></h2>
<div class="proof proof-type-exercise" id="id36">

    <div class="proof-title">
        <span class="proof-type">Exercise 16.20</span>
        
    </div><div class="proof-content">
<p>Assume we have a time series with <em>n</em> observations.
What is a 1- and an <em>n</em>-moving average?
Which one is smoother, a <em>(0.01n)</em>- or a <em>(0.1n)</em>- one?</p>
</div></div><div class="proof proof-type-exercise" id="id37">

    <div class="proof-title">
        <span class="proof-type">Exercise 16.21</span>
        
    </div><div class="proof-content">
<p>What is the UNIX Epoch?</p>
</div></div><div class="proof proof-type-exercise" id="id38">

    <div class="proof-title">
        <span class="proof-type">Exercise 16.22</span>
        
    </div><div class="proof-content">
<p>How can we recreate the original series
when we are given its <strong class="command">numpy.diff</strong>-transformed version?</p>
</div></div><div class="proof proof-type-exercise" id="id39">

    <div class="proof-title">
        <span class="proof-type">Exercise 16.23</span>
        
    </div><div class="proof-content">
<p>(*) In your own words, describe the key elements
of a candlestick plot.</p>
</div></div><hr class="footnotes docutils" />
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="footmidrange" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id2">1</a><span class="fn-bracket">]</span></span>
<p>Note that midrange, being the mean of the lowest
and the highest observed temperature on a given day, is not a
particularly good estimate of the average daily reading.
This dataset is considered for illustrational purposes only.</p>
</aside>
</aside>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="998-changelog.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Changelog</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="520-missingness.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title"><span class="section-number">15. </span>Missing, censored, and questionable data</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
              
              
              Copyright &#169; 2022–2023 by <a href="https://www.gagolewski.com">Marek Gagolewski</a>.
              Some rights reserved. Licensed under <a href='https://creativecommons.org/licenses/by-nc-nd/4.0/'>CC BY-NC-ND 4.0</a>.
              Built with <a href="https://sphinx-doc.org/">Sphinx</a>
              and a customised <a href="https://github.com/pradyunsg/furo">Furo</a> theme.
              Last updated on 2023-05-01T15:49:55+1000.
              This site will never display any ads: it is a non-profit project.
              It does not collect any data.
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            In this chapter
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">16. Time series</a><ul>
<li><a class="reference internal" href="#temporal-ordering-and-line-charts">16.1. Temporal ordering and line charts</a></li>
<li><a class="reference internal" href="#working-with-date-times-and-time-deltas">16.2. Working with date-times and time-deltas</a><ul>
<li><a class="reference internal" href="#representation-the-unix-epoch">16.2.1. Representation: The UNIX epoch</a></li>
<li><a class="reference internal" href="#time-differences">16.2.2. Time differences</a></li>
<li><a class="reference internal" href="#date-times-in-data-frames">16.2.3. Date-times in data frames</a></li>
</ul>
</li>
<li><a class="reference internal" href="#basic-operations">16.3. Basic operations</a><ul>
<li><a class="reference internal" href="#iterated-differences-and-cumulative-sums-revisited">16.3.1. Iterated differences and cumulative sums revisited</a></li>
<li><a class="reference internal" href="#smoothing-with-moving-averages">16.3.2. Smoothing with moving averages</a></li>
<li><a class="reference internal" href="#detecting-trends-and-seasonal-patterns">16.3.3. Detecting trends and seasonal patterns</a></li>
<li><a class="reference internal" href="#imputing-missing-values">16.3.4. Imputing missing values</a></li>
<li><a class="reference internal" href="#plotting-multidimensional-time-series">16.3.5. Plotting multidimensional time series</a></li>
<li><a class="reference internal" href="#candlestick-plots">16.3.6. Candlestick plots (*)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#further-reading">16.4. Further reading</a></li>
<li><a class="reference internal" href="#exercises">16.5. Exercises</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/scripts/furo.js"></script>
    <script src="../_static/proof.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    </body>
</html>